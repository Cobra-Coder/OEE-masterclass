<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OEE Masterclass | Smart Factory Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0F172A;
            --panel-dark: #1E293B;
            --accent-cyan: #06B6D4;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-amber: #F59E0B;
            --accent-purple: #A855F7;
        }
        
        body {
            background-color: var(--bg-dark);
            color: #E2E8F0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .scada-panel {
            background: var(--panel-dark);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 40;
            opacity: 0.15;
        }

        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.6s ease-out forwards; }

        @keyframes conveyor {
            0% { transform: translateX(0); }
            100% { transform: translateX(-64px); } /* Width of unit + gap */
        }
        .conveyor-belt { animation: conveyor 0.5s linear infinite; }
        
        /* States */
        .state-running { animation-duration: 0.5s; }
        .state-slow { animation-duration: 1.2s; }
        .state-jammed { animation: shake 0.5s ease-in-out infinite; }
        .state-down { animation: none; filter: grayscale(100%) opacity(50%); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }
        .alarm-active { animation: pulse-red 1.5s infinite; }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: white;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
        }
        input[type=range]:focus { outline: none; }
        
        /* Input Field Styling */
        .input-dark {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s;
        }
        .input-dark:focus {
            border-color: var(--accent-cyan);
            outline: none;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }
        /* Custom scrollbar for panels */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Audio Engine (Browser Native Synth) ---
        const AudioEngine = {
            ctx: null,
            osc: null,
            gain: null,

            init: () => {
                if (!AudioEngine.ctx) {
                    AudioEngine.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (AudioEngine.ctx.state === 'suspended') {
                    AudioEngine.ctx.resume();
                }
            },

            // playHum Removed/Silenced per request
            playHum: (active) => {
                // Function retained but logic cleared to remove constant background noise
                return; 
            },

            playAlarm: () => {
                AudioEngine.init();
                const osc = AudioEngine.ctx.createOscillator();
                const gain = AudioEngine.ctx.createGain();
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, AudioEngine.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(880, AudioEngine.ctx.currentTime + 0.1);
                
                gain.gain.setValueAtTime(0.1, AudioEngine.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, AudioEngine.ctx.currentTime + 0.5);

                osc.connect(gain);
                gain.connect(AudioEngine.ctx.destination);
                osc.start();
                osc.stop(AudioEngine.ctx.currentTime + 0.5);
            },

            playSuccess: () => {
                AudioEngine.init();
                const now = AudioEngine.ctx.currentTime;
                [523.25, 659.25, 783.99].forEach((freq, i) => { 
                    const osc = AudioEngine.ctx.createOscillator();
                    const gain = AudioEngine.ctx.createGain();
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.value = 0.05;
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                    
                    osc.connect(gain);
                    gain.connect(AudioEngine.ctx.destination);
                    osc.start(now + i * 0.1);
                    osc.stop(now + 2);
                });
            }
        };

        // --- Visual Components ---

        const MissionBriefing = ({ onStart, hasSave }) => (
            <div className="h-screen w-full flex flex-col items-center justify-center p-8 relative z-50 bg-slate-900">
                <div className="max-w-5xl w-full grid md:grid-cols-2 gap-16 items-center animate-slide-up">
                    <div>
                        <div className="text-cyan-400 font-mono text-xs mb-4 tracking-widest uppercase">/// Simulation Initiated</div>
                        <h1 className="text-5xl md:text-6xl font-bold text-white mb-6 leading-tight">
                            Mastering <span className="text-cyan-400">OEE</span>
                        </h1>
                        <p className="text-lg text-slate-400 leading-relaxed mb-8">
                            Welcome, Plant Manager. You are taking over <strong>Line 04: High-Speed Bottling</strong> for the Day Shift.
                            <br/><br/>
                            Your mission is to diagnose the <strong>Three Loss Factors</strong> (Availability, Performance, Quality) that are destroying your efficiency.
                        </p>
                        
                        <div className="grid grid-cols-2 gap-4 mb-8">
                            <div className="scada-panel p-4 rounded-lg border-l-4 border-blue-500">
                                <div className="text-xs text-slate-500 uppercase">Shift Length</div>
                                <div className="font-mono text-xl font-bold text-white">480 min</div>
                            </div>
                            <div className="scada-panel p-4 rounded-lg border-l-4 border-green-500">
                                <div className="text-xs text-slate-500 uppercase">Design Speed</div>
                                <div className="font-mono text-xl font-bold text-white">400 bpm</div>
                            </div>
                        </div>

                        <div className="flex gap-4">
                            <button 
                                onClick={() => onStart(false)}
                                className="bg-cyan-600 hover:bg-cyan-500 text-white text-lg font-bold py-4 px-8 rounded-lg shadow-[0_0_20px_rgba(6,182,212,0.4)] transition-all flex-1 flex items-center justify-center gap-3 group"
                            >
                                START NEW SHIFT <i className="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </button>
                            {hasSave && (
                                <button 
                                    onClick={() => onStart(true)}
                                    className="bg-slate-700 hover:bg-slate-600 text-white text-lg font-bold py-4 px-8 rounded-lg transition-all flex items-center justify-center gap-3"
                                >
                                    RESUME <i className="ph-bold ph-arrow-u-up-right"></i>
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div className="relative h-96 scada-panel rounded-2xl overflow-hidden border border-slate-700/50 hidden md:flex items-center justify-center bg-slate-800">
                        <div className="absolute inset-0 opacity-20 scanlines"></div>
                        <div className="text-center relative z-10">
                             <div className="w-32 h-32 rounded-full border-4 border-cyan-500/30 flex items-center justify-center mx-auto mb-6 animate-pulse relative">
                                <i className="ph-duotone ph-factory text-7xl text-cyan-400"></i>
                                <div className="absolute -top-2 -right-2 w-6 h-6 bg-green-500 rounded-full animate-ping"></div>
                                <div className="absolute -top-2 -right-2 w-6 h-6 bg-green-500 rounded-full"></div>
                             </div>
                             <div className="font-mono text-cyan-500 text-sm tracking-widest">SYSTEM ONLINE</div>
                             <div className="font-mono text-slate-500 text-xs mt-2">OEE CALCULATION ENGINE READY</div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const MachineVisual = ({ state, subText }) => {
            const isAlarm = state === 'down' || state === 'jammed';
            
            useEffect(() => {
                if (isAlarm) AudioEngine.playAlarm();
            }, [state]);

            return (
                <div className={`w-full h-64 bg-slate-800 rounded-xl relative overflow-hidden border-b-4 transition-all duration-500 ${isAlarm ? 'border-red-500 alarm-active' : 'border-slate-700'}`}>
                    <div className="absolute top-4 right-6 flex flex-col gap-1 z-20 bg-slate-900 p-1 rounded border border-slate-700">
                        <div className={`w-3 h-3 rounded-full ${state === 'down' ? 'bg-red-500 animate-pulse shadow-[0_0_8px_red]' : 'bg-red-900'}`}></div>
                        <div className={`w-3 h-3 rounded-full ${state === 'jammed' ? 'bg-amber-500 animate-pulse shadow-[0_0_8px_orange]' : 'bg-amber-900'}`}></div>
                        <div className={`w-3 h-3 rounded-full ${state === 'running' || state === 'slow' ? 'bg-green-500 shadow-[0_0_8px_lime]' : 'bg-green-900'}`}></div>
                    </div>

                    <div className="absolute inset-0 flex items-center justify-center">
                        <div className="relative w-64 h-40 bg-slate-700 rounded-lg border border-slate-600 flex items-center justify-center z-10">
                            <i className={`ph-fill ph-gear text-8xl text-slate-500/50 absolute -left-8 -top-8 ${state === 'down' ? '' : 'animate-spin'}`} style={{animationDuration: state === 'slow' ? '4s' : '2s'}}></i>
                            <div className="z-20 text-center">
                                <div className={`text-2xl font-black font-mono uppercase tracking-widest ${isAlarm ? 'text-red-500' : 'text-green-500'}`}>
                                    {state}
                                </div>
                                <div className="text-xs text-slate-300 font-mono mt-1">{subText}</div>
                            </div>
                        </div>
                    </div>

                    <div className="absolute bottom-0 left-0 right-0 h-16 bg-slate-900 z-10 flex items-center overflow-hidden">
                        <div className={`flex gap-16 px-4 w-[200%] ${state === 'down' ? '' : state === 'jammed' ? 'state-jammed' : 'conveyor-belt'} ${state === 'slow' ? 'state-slow' : 'state-running'}`}>
                            {[...Array(12)].map((_, i) => (
                                <div key={i} className="w-8 h-12 relative shrink-0">
                                    <div className={`w-full h-full rounded-sm border-2 backdrop-blur-sm ${
                                        subText.includes('Defect') && i % 3 === 0 ? 'bg-red-500/40 border-red-400' : 'bg-cyan-500/40 border-cyan-400'
                                    }`}>
                                        <div className="absolute -top-2 left-2 w-4 h-2 bg-slate-300"></div>
                                    </div>
                                    {subText.includes('Defect') && i % 3 === 0 && (
                                        <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-[9px] text-red-500 font-bold">X</div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const InfoCard = ({ title, desc, icon, color }) => (
            <div className={`bg-${color}-900/20 border border-${color}-500/30 p-4 rounded-lg flex gap-4 items-start`}>
                <div className={`p-2 rounded bg-${color}-500/10 text-${color}-400`}>
                    <i className={`ph-fill ${icon} text-xl`}></i>
                </div>
                <div>
                    <h4 className={`text-${color}-400 font-bold text-sm uppercase mb-1`}>{title}</h4>
                    <p className="text-slate-400 text-xs leading-relaxed">{desc}</p>
                </div>
            </div>
        );

        const SliderInput = ({ label, value, min, max, unit, onChange, color = "cyan" }) => (
            <div className="mb-6">
                <div className="flex justify-between items-end mb-2">
                    <label className="text-sm font-medium text-slate-300">{label}</label>
                    <span className={`font-mono text-${color}-400 font-bold`}>{value} {unit}</span>
                </div>
                <input 
                    type="range" min={min} max={max} value={value} 
                    onChange={(e) => onChange(Number(e.target.value))}
                    className="w-full"
                />
                <div className="w-full h-1 bg-slate-800 rounded overflow-hidden mt-1">
                    <div className={`h-full bg-${color}-500 transition-all duration-300`} style={{width: `${(value/max)*100}%`}}></div>
                </div>
            </div>
        );

        // --- Modules ---

        const AvailabilityModule = ({ data, updateData }) => {
            const totalLoss = data.equipmentFailure + data.setupTime + data.materialShortage;
            const plannedProdTime = 450;
            const runTime = plannedProdTime - totalLoss;
            const score = ((runTime / plannedProdTime) * 100).toFixed(1);

            let machineState = 'running';
            let subText = 'Operations Normal';
            if (data.equipmentFailure > 0) { machineState = 'down'; subText = 'CRITICAL FAILURE'; }
            else if (data.materialShortage > 0) { machineState = 'down'; subText = 'WAITING FOR MATERIALS'; }
            else if (data.setupTime > 0) { machineState = 'down'; subText = 'CHANGEOVER IN PROGRESS'; }

            return (
                <div className="grid lg:grid-cols-2 gap-8 h-full content-start animate-slide-up">
                    <div className="space-y-6">
                        <MachineVisual state={machineState} subText={subText} />
                        <div className="grid grid-cols-2 gap-4">
                            <div className="scada-panel p-4 rounded">
                                <div className="text-xs text-slate-500 uppercase">Run Time</div>
                                <div className="text-2xl font-mono text-white font-bold">{runTime}m</div>
                            </div>
                            <div className="scada-panel p-4 rounded border border-blue-500/30">
                                <div className="text-xs text-blue-400 uppercase">Availability Score</div>
                                <div className="text-3xl font-mono text-blue-400 font-bold">{score}%</div>
                            </div>
                        </div>
                        <InfoCard color="blue" icon="ph-wrench" title="Availability Losses" desc="Time when the machine should be running but isn't. Includes breakdowns, setup/adjustments, and waiting for materials." />
                    </div>
                    <div className="scada-panel p-8 rounded-xl">
                        <h3 className="text-white font-bold mb-6 border-b border-slate-700 pb-4">Loss Inputs</h3>
                        <SliderInput label="Equipment Failure" unit="min" min={0} max={120} value={data.equipmentFailure} onChange={(v) => updateData('equipmentFailure', v)} color="red" />
                        <SliderInput label="Setup & Adjustments" unit="min" min={0} max={60} value={data.setupTime} onChange={(v) => updateData('setupTime', v)} color="amber" />
                        <SliderInput label="Material Shortage" unit="min" min={0} max={60} value={data.materialShortage} onChange={(v) => updateData('materialShortage', v)} color="slate" />
                    </div>
                </div>
            );
        };

        const PerformanceModule = ({ data, availData, updateData }) => {
            const runTime = 450 - (availData.equipmentFailure + availData.setupTime + availData.materialShortage);
            const idealOutput = runTime * 400;
            const speedLoss = (400 - data.runSpeed) * runTime;
            const stopLoss = data.microStops * 10; 
            const maxPossible = runTime * 400;
            const actualOutput = Math.max(0, maxPossible - speedLoss - stopLoss);
            const score = runTime > 0 ? ((actualOutput / idealOutput) * 100).toFixed(1) : 0;

            let machineState = 'running';
            let subText = 'Optimal Speed';
            if (data.microStops > 20) { machineState = 'jammed'; subText = 'FREQUENT JAMS'; }
            else if (data.runSpeed < 350) { machineState = 'slow'; subText = 'REDUCED SPEED'; }

            return (
                <div className="grid lg:grid-cols-2 gap-8 h-full content-start animate-slide-up">
                    <div className="space-y-6">
                        <MachineVisual state={machineState} subText={subText} />
                        <div className="grid grid-cols-2 gap-4">
                             <div className="scada-panel p-4 rounded">
                                <div className="text-xs text-slate-500 uppercase">Ideal Output</div>
                                <div className="text-xl font-mono text-white font-bold">{idealOutput.toLocaleString()}</div>
                            </div>
                             <div className="scada-panel p-4 rounded border border-purple-500/30">
                                <div className="text-xs text-purple-400 uppercase">Performance Score</div>
                                <div className="text-3xl font-mono text-purple-400 font-bold">{score}%</div>
                            </div>
                        </div>
                        <InfoCard color="purple" icon="ph-gauge" title="Performance Losses" desc="Running slower than Design Speed (Reduced Speed) or short interruptions < 5 mins (Minor Stops/Idling)." />
                    </div>
                    <div className="scada-panel p-8 rounded-xl">
                        <h3 className="text-white font-bold mb-6 border-b border-slate-700 pb-4">Loss Inputs</h3>
                        <SliderInput label="Operator Speed Setting" unit="bpm" min={200} max={400} value={data.runSpeed} onChange={(v) => updateData('runSpeed', v)} color="purple" />
                        <SliderInput label="Micro-Stops (Jams/Shift)" unit="events" min={0} max={50} value={data.microStops} onChange={(v) => updateData('microStops', v)} color="amber" />
                    </div>
                </div>
            );
        };

        const QualityModule = ({ data, perfOutput, updateData }) => {
            const totalProduced = perfOutput;
            const totalRejects = data.startupRejects + data.processDefects;
            const goodCount = Math.max(0, totalProduced - totalRejects);
            const score = totalProduced > 0 ? ((goodCount / totalProduced) * 100).toFixed(1) : 0;

            let subText = 'Yield 100%';
            if (totalRejects > 1000) subText = 'Detecting Defects...';
            
            return (
                <div className="grid lg:grid-cols-2 gap-8 h-full content-start animate-slide-up">
                    <div className="space-y-6">
                        <MachineVisual state="running" subText={subText} />
                         <div className="grid grid-cols-2 gap-4">
                             <div className="scada-panel p-4 rounded">
                                <div className="text-xs text-slate-500 uppercase">Good Units</div>
                                <div className="text-xl font-mono text-white font-bold">{goodCount.toLocaleString()}</div>
                            </div>
                             <div className="scada-panel p-4 rounded border border-amber-500/30">
                                <div className="text-xs text-amber-400 uppercase">Quality Score</div>
                                <div className="text-3xl font-mono text-amber-400 font-bold">{score}%</div>
                            </div>
                        </div>
                        <InfoCard color="amber" icon="ph-shield-check" title="Quality Losses" desc="Products that don't meet specs. Includes Scrap (trash) and Rework (fixable)." />
                    </div>
                     <div className="scada-panel p-8 rounded-xl">
                        <h3 className="text-white font-bold mb-6 border-b border-slate-700 pb-4">Loss Inputs</h3>
                        <SliderInput label="Startup Rejects" unit="units" min={0} max={2000} value={data.startupRejects} onChange={(v) => updateData('startupRejects', v)} color="amber" />
                        <SliderInput label="Process Defects" unit="units" min={0} max={5000} value={data.processDefects} onChange={(v) => updateData('processDefects', v)} color="red" />
                    </div>
                </div>
            );
        };

        // --- New Financial & Dashboard Component ---
        const Dashboard = ({ availData, perfData, qualData, financials, setFinancials }) => {
            // 1. Calculate Scores
            const plannedTime = 450;
            const lossA_Time = availData.equipmentFailure + availData.setupTime + availData.materialShortage;
            const runTime = plannedTime - lossA_Time;
            const A = runTime / plannedTime;

            // Perf Calcs
            const idealOutput = runTime * 400;
            const speedLossUnits = (400 - perfData.runSpeed) * runTime;
            const stopLossUnits = perfData.microStops * 10;
            const totalPerfLossUnits = speedLossUnits + stopLossUnits;
            const actualOutput = Math.max(0, idealOutput - totalPerfLossUnits);
            const P = runTime > 0 ? actualOutput / idealOutput : 0;

            // Qual Calcs
            const totalRejects = qualData.startupRejects + qualData.processDefects;
            const goodUnits = Math.max(0, actualOutput - totalRejects);
            const Q = actualOutput > 0 ? goodUnits / actualOutput : 0;

            const OEE = (A * P * Q * 100).toFixed(1);

            // 2. Calculate Financials
            const lossP_Time = totalPerfLossUnits / 400;
            
            const totalLostTime = lossA_Time + lossP_Time;
            const costLostTime = totalLostTime * financials.costPerMinute;
            const costRejects = totalRejects * financials.costPerUnit;
            const totalFinancialLoss = costLostTime + costRejects;

            useEffect(() => {
                if (OEE > 80) AudioEngine.playSuccess();
            }, []);

            const recommendations = [
                { 
                    title: "Availability", 
                    val: ((1-A)*100).toFixed(1) + "%", 
                    color: "red", 
                    icon: "ph-wrench", 
                    fix: "Implement Single Minute Exchange of Die (SMED) techniques to drastically reduce changeover times. Adopt a Total Productive Maintenance (TPM) program and Predictive Maintenance sensors to anticipate and prevent equipment failures."
                },
                { 
                    title: "Performance", 
                    val: (A*(1-P)*100).toFixed(1) + "%", 
                    color: "purple", 
                    icon: "ph-gauge", 
                    fix: "Utilize the Theory of Constraints to identify and elevate the line's bottleneck. Implement Centerlining to standardize machine settings and prevent speed variance. Install automated de-jamming mechanisms to absorb minor stops."
                },
                { 
                    title: "Quality", 
                    val: (A*P*(1-Q)*100).toFixed(1) + "%", 
                    color: "amber", 
                    icon: "ph-shield-warning", 
                    fix: "Deploy inline Machine Vision systems for real-time defect detection. Apply Statistical Process Control (SPC) charts to monitor process stability. Implement Poka-Yoke (Error Proofing) mechanisms to prevent defects."
                }
            ];

            return (
                <div className="h-full flex flex-col items-center justify-center animate-slide-up max-w-7xl mx-auto w-full">
                    <div className="grid lg:grid-cols-2 gap-8 w-full h-full">
                        
                        {/* LEFT COLUMN: Score + Financials */}
                        <div className="flex flex-col gap-6 h-full">
                            
                            {/* Top: OEE Score & Benchmark */}
                            <div className="scada-panel p-6 rounded-xl">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <div className="text-cyan-500 font-mono text-sm uppercase tracking-widest mb-2">Efficiency Score</div>
                                        <h2 className="text-7xl font-bold text-white font-mono">{OEE}%</h2>
                                    </div>
                                    
                                    {/* Benchmark Chart */}
                                    <div className="w-1/2 space-y-2">
                                        <div className="text-[10px] text-slate-500 uppercase text-right mb-1">Industry Context</div>
                                        <div className="flex items-center justify-end gap-2 text-xs">
                                            <span className="text-green-500 font-bold">85%</span>
                                            <div className="w-24 h-2 bg-slate-800 rounded overflow-hidden"><div className="h-full bg-green-500" style={{width: '85%'}}></div></div>
                                            <span className="w-16 text-slate-400 text-right">World Class</span>
                                        </div>
                                        <div className="flex items-center justify-end gap-2 text-xs">
                                            <span className="text-slate-500 font-bold">60%</span>
                                            <div className="w-24 h-2 bg-slate-800 rounded overflow-hidden"><div className="h-full bg-slate-500" style={{width: '60%'}}></div></div>
                                            <span className="w-16 text-slate-400 text-right">Average</span>
                                        </div>
                                        <div className="flex items-center justify-end gap-2 text-xs">
                                            <span className="text-cyan-400 font-bold">{OEE}%</span>
                                            <div className="w-24 h-2 bg-slate-800 rounded overflow-hidden"><div className="h-full bg-cyan-500" style={{width: `${Math.min(OEE, 100)}%`}}></div></div>
                                            <span className="w-16 text-cyan-400 text-right">You</span>
                                        </div>
                                    </div>
                                </div>

                                {/* A/P/Q Mini Cards */}
                                <div className="grid grid-cols-3 gap-2">
                                    <div className="bg-slate-900/50 p-3 rounded border-t-2 border-blue-500 text-center">
                                        <div className="text-slate-500 text-[10px] uppercase font-bold">Availability</div>
                                        <div className="text-xl font-mono font-bold text-white">{(A*100).toFixed(0)}%</div>
                                    </div>
                                    <div className="bg-slate-900/50 p-3 rounded border-t-2 border-purple-500 text-center">
                                        <div className="text-slate-500 text-[10px] uppercase font-bold">Performance</div>
                                        <div className="text-xl font-mono font-bold text-white">{(P*100).toFixed(0)}%</div>
                                    </div>
                                    <div className="bg-slate-900/50 p-3 rounded border-t-2 border-amber-500 text-center">
                                        <div className="text-slate-500 text-[10px] uppercase font-bold">Quality</div>
                                        <div className="text-xl font-mono font-bold text-white">{(Q*100).toFixed(0)}%</div>
                                    </div>
                                </div>
                            </div>

                            {/* Bottom: Financial Impact Calculator */}
                            <div className="scada-panel p-6 rounded-xl border border-slate-600 bg-slate-800/30 flex-1 flex flex-col justify-center">
                                 <h3 className="text-white font-bold mb-6 flex items-center gap-2 border-b border-slate-700 pb-2">
                                    <i className="ph-fill ph-currency-dollar text-green-400"></i> Financial Impact Monitor
                                </h3>
                                
                                 <div className="grid grid-cols-2 gap-8 mb-6">
                                    <div>
                                        <div className="text-[10px] uppercase text-slate-500 mb-2 font-bold">Downtime Cost Factor</div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-slate-400">$</span>
                                            <input 
                                                type="number" 
                                                value={financials.costPerMinute} 
                                                onChange={(e) => setFinancials({...financials, costPerMinute: Number(e.target.value)})} 
                                                className="w-24 input-dark rounded px-2 py-1 text-lg font-bold" 
                                            />
                                            <span className="text-xs text-slate-500">/min</span>
                                        </div>
                                        <div className="text-sm text-slate-300"><span className="font-mono font-bold text-white">{totalLostTime.toFixed(0)}</span> min lost</div>
                                        <div className="text-xs text-red-400 font-mono">-${costLostTime.toLocaleString()}</div>
                                    </div>
                                     <div>
                                        <div className="text-[10px] uppercase text-slate-500 mb-2 font-bold">Rejection Cost Factor</div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-slate-400">$</span>
                                            <input 
                                                type="number" 
                                                value={financials.costPerUnit} 
                                                onChange={(e) => setFinancials({...financials, costPerUnit: Number(e.target.value)})} 
                                                className="w-24 input-dark rounded px-2 py-1 text-lg font-bold" 
                                            />
                                            <span className="text-xs text-slate-500">/unit</span>
                                        </div>
                                        <div className="text-sm text-slate-300"><span className="font-mono font-bold text-white">{totalRejects.toLocaleString()}</span> rejects</div>
                                        <div className="text-xs text-red-400 font-mono">-${costRejects.toLocaleString()}</div>
                                    </div>
                                 </div>
                                 
                                 <div className="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-center shadow-[0_0_30px_rgba(239,68,68,0.1)]">
                                     <div className="text-xs text-red-300 uppercase tracking-widest mb-1 font-bold">Total Opportunity Cost</div>
                                     <div className="text-4xl font-mono font-bold text-red-500 tracking-tight">-${totalFinancialLoss.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                 </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: Analysis & Solutions */}
                        <div className="scada-panel p-8 rounded-xl h-full flex flex-col overflow-hidden">
                            <h3 className="text-white font-bold mb-6 flex items-center gap-2 border-b border-slate-700 pb-4">
                                <i className="ph-fill ph-clipboard-text text-cyan-400"></i> Loss Analysis & Solutions
                            </h3>
                            
                            <div className="space-y-4 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                                {recommendations.map((rec, i) => (
                                    <div key={i} className={`bg-slate-900/50 p-5 rounded-lg border-l-4 border-${rec.color}-500 hover:bg-slate-800 transition-colors group`}>
                                        <div className="flex justify-between items-center mb-3">
                                            <div className={`flex items-center gap-2 text-${rec.color}-400 font-bold uppercase text-sm`}>
                                                <div className={`p-1.5 rounded bg-${rec.color}-500/20`}><i className={`ph-fill ${rec.icon} text-lg`}></i></div>
                                                {rec.title} Loss
                                            </div>
                                            <div className="text-white font-mono font-bold text-lg">-{rec.val}</div>
                                        </div>
                                        <div className="pl-9">
                                            <div className="text-xs text-slate-500 uppercase mb-1 font-bold">Recommended Action:</div>
                                            <p className="text-slate-300 text-sm leading-relaxed group-hover:text-white transition-colors">{rec.fix}</p>
                                        </div>
                                    </div>
                                ))}
                                
                                <div className="mt-6 p-4 rounded bg-slate-800 border border-slate-700 text-xs text-slate-400 leading-relaxed">
                                    <strong className="text-white block mb-1"><i className="ph-fill ph-info text-cyan-400 mr-1"></i> Manager's Insight:</strong>
                                    Focus on the "Constraint" first. Fixing the largest percentage loss typically yields the highest ROI. In this scenario, reducing <strong>{
                                        Math.max((1-A), A*(1-P), A*P*(1-Q)) === (1-A) ? "Availability" : 
                                        Math.max((1-A), A*(1-P), A*P*(1-Q)) === A*(1-P) ? "Performance" : "Quality"
                                    } Loss</strong> should be your priority.
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- Main Orchestrator ---
        const App = () => {
            const [started, setStarted] = useState(false);
            const [phase, setPhase] = useState(0);
            
            // State Persistence
            const [availData, setAvailData] = useState(() => {
                const saved = localStorage.getItem('oee_avail');
                return saved ? JSON.parse(saved) : { equipmentFailure: 0, setupTime: 0, materialShortage: 0 };
            });
            const [perfData, setPerfData] = useState(() => {
                const saved = localStorage.getItem('oee_perf');
                return saved ? JSON.parse(saved) : { runSpeed: 400, microStops: 0 };
            });
            const [qualData, setQualData] = useState(() => {
                const saved = localStorage.getItem('oee_qual');
                return saved ? JSON.parse(saved) : { startupRejects: 0, processDefects: 0 };
            });

            // New Financial State
            const [financials, setFinancials] = useState({ costPerMinute: 100, costPerUnit: 2.50 });

            useEffect(() => { localStorage.setItem('oee_avail', JSON.stringify(availData)); }, [availData]);
            useEffect(() => { localStorage.setItem('oee_perf', JSON.stringify(perfData)); }, [perfData]);
            useEffect(() => { localStorage.setItem('oee_qual', JSON.stringify(qualData)); }, [qualData]);

            const handleUpdate = (setter) => (key, val) => setter(prev => ({...prev, [key]: val}));

            // Shared Calc
            const getRunTime = () => 450 - (availData.equipmentFailure + availData.setupTime + availData.materialShortage);
            const getPerfOutput = () => {
                const rt = getRunTime();
                const speedLoss = (400 - perfData.runSpeed) * rt;
                const stopLoss = perfData.microStops * 10;
                return Math.max(0, (rt * 400) - speedLoss - stopLoss);
            };

            // Audio - Hum removed, logic kept for future if needed but silenced
            useEffect(() => {
                // Background hum silenced as per request
            }, [started, phase]);

            // Handlers
            const handleStart = (resume) => {
                if (!resume) {
                    setAvailData({ equipmentFailure: 0, setupTime: 0, materialShortage: 0 });
                    setPerfData({ runSpeed: 400, microStops: 0 });
                    setQualData({ startupRejects: 0, processDefects: 0 });
                    setPhase(0);
                }
                setStarted(true);
                AudioEngine.init(); 
            };

            if (!started) return <MissionBriefing onStart={handleStart} hasSave={!!localStorage.getItem('oee_avail')} />;

            return (
                <div className="h-screen flex flex-col relative">
                    <div className="scanlines"></div>
                    
                    <header className="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 z-50">
                        <div className="flex items-center gap-2 text-cyan-400">
                            <i className="ph-duotone ph-factory text-2xl"></i>
                            <span className="font-mono font-bold tracking-wider">OEE SIM // PRO</span>
                        </div>
                        <div className="flex gap-1">
                            {['Availability', 'Performance', 'Quality', 'Report'].map((n, i) => (
                                <div key={n} className={`px-4 py-1 rounded text-xs font-bold transition-all ${phase === i ? 'bg-cyan-600 text-white' : 'text-slate-600'}`}>
                                    {i+1}. {n}
                                </div>
                            ))}
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-6 md:p-12 z-10">
                        <div className="max-w-7xl mx-auto h-full">
                            {phase === 0 && <AvailabilityModule data={availData} updateData={handleUpdate(setAvailData)} />}
                            {phase === 1 && <PerformanceModule data={perfData} availData={availData} updateData={handleUpdate(setPerfData)} />}
                            {phase === 2 && <QualityModule data={qualData} perfOutput={getPerfOutput()} updateData={handleUpdate(setQualData)} />}
                            {phase === 3 && (
                                <Dashboard 
                                    availData={availData} 
                                    perfData={perfData} 
                                    qualData={qualData}
                                    financials={financials}
                                    setFinancials={setFinancials}
                                />
                            )}
                        </div>
                    </main>

                    <footer className="h-20 bg-slate-900 border-t border-slate-800 flex items-center justify-between px-8 z-50">
                        <div className="text-[10px] text-slate-600 font-mono flex items-center gap-1">
                            &copy; Designed by Madhusudan Chhangani
                        </div>
                        <button 
                            onClick={() => setPhase(p => p < 3 ? p + 1 : 0)}
                            className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded flex items-center gap-2 shadow-lg transition-transform active:scale-95"
                        >
                            {phase === 3 ? 'RESET SIMULATION' : 'NEXT PHASE'} 
                            <i className={`ph-bold ${phase === 3 ? 'ph-arrow-counter-clockwise' : 'ph-arrow-right'}`}></i>
                        </button>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
